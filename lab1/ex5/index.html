<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Упражнение 5 - My Docs</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u0423\u043f\u0440\u0430\u0436\u043d\u0435\u043d\u0438\u0435 5";
        var mkdocs_page_input_path = "lab1\\ex5.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> My Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Лабораторная работа 1</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../ex1/">Упраженение 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ex2/">Упражнение 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ex3/">Упражнение 3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ex4/">Упраженение 4</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Упражнение 5</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_1">Код</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_2">Код сервера</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#update_markshtml">Код update_marks.html</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">My Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Лабораторная работа 1</li>
      <li class="breadcrumb-item active">Упражнение 5</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="5">Упражнение 5</h1>
<h2 id="_1">Код</h2>
<h3 id="_2">Код сервера</h3>
<pre><code class="language-python">import socket
import logging
from io import BufferedWriter, BufferedReader
import email.parser
import email.message
from urllib.parse import  parse_qs, urlparse
from dataclasses import dataclass
from typing import List, Tuple, Dict

class Request:
    &quot;&quot;&quot;
    Class containing request data
    &quot;&quot;&quot;
    def __init__(self, method, target, version, headers, rfile):
        self.method = method # get, post ...
        self.target = target # url
        self.version = version
        self.headers = headers #
        self.rfile = rfile

    @property
    def url_path(self):
        return self.url.path

    @property
    def url_params(self):
        return parse_qs(self.url.query)

    @property
    def url(self):
        return urlparse(self.target)

    @property
    def body(self):
        size = self.headers.get('Content-Length')
        if not size:
            return None
        else:
            size = int(size)
        return self.rfile.read(size)


class ConnWriter:
    &quot;&quot;&quot;
    Wrapper around file interface of socket
    &quot;&quot;&quot;
    encoding = 'iso-8859-1'

    def __init__(self, wfile: BufferedWriter):
        self._wfile = wfile

    def encode_and_write(self, s: str):
        if not s.endswith('\r\n'):
            s += '\r\n'
        encoded = s.encode(self.encoding)
        self._wfile.write(encoded)

    def write_empty_line(self):
        self._wfile.write(b'\r\n')

    def write_bytes(self, s: bytes):
        if not s.endswith(b'\r\n'):
            s += b'\r\n'
        self._wfile.write(s)

    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        self._wfile.flush()
        self._wfile.close()


@dataclass(frozen=True)
class Response:
    &quot;&quot;&quot;
    Dataclass from which response created
    &quot;&quot;&quot;
    status: int
    reason: str
    headers: List[Tuple] = None
    body: bytes = None


class MyHTTPServer:
    &quot;&quot;&quot;
    Accept requests, generate responses
    &quot;&quot;&quot;
    def __init__(self, host, port, server_name):
        self._host = host
        self._port = port
        self._server_name = server_name
        self.marks: Dict[str, List[int]] = {&quot;Math&quot;: [5], 'Programming': [4]}
        &quot;&quot;&quot;Dict to imitate database. Already packed with some values&quot;&quot;&quot;


    def serve_forever(self):
        &quot;&quot;&quot;
        Starts server. Main function of a class
        &quot;&quot;&quot;

        conn = socket.socket(socket.AF_INET, socket.SOCK_STREAM, proto=0)
        try:
            conn.bind((self._host, self._port))
            conn.listen(10)
            while True:
                client_conn, client_address = conn.accept()
                self.serve_client(client_conn)
        finally:
            conn.close()

    def serve_client(self, client_conn):
        &quot;&quot;&quot;
        Get response from a client and send appropriate response
        &quot;&quot;&quot;
        request = self.parse_request(client_conn)
        response = self.handle_request(request)
        self.send_response(client_conn, response)

    def parse_request(self, conn):
        &quot;&quot;&quot;
        Convert request into Request instance
        &quot;&quot;&quot;
        rfile = conn.makefile('rb')
        method, target, version = self.parse_request_line(rfile)
        logging.debug(f'request_line: {method} {target} {version}')
        headers = self.parse_headers(rfile)
        logging.debug(f'headers:\n{headers}')
        self.check_host(headers)

        return Request(method, target, version, headers, rfile)

    def parse_request_line(self, rfile):
        request_line = rfile.readline().decode('iso-8859-1')
        request_line = request_line.rstrip('\r\n')
        method, target, version = request_line.split()
        if version != 'HTTP/1.1':
            raise Exception('Invalid HTTP version')
        return method, target, version

    def parse_headers(self, rfile: BufferedReader) -&gt; email.message.Message:
        headers_list = []
        while True:
            line = rfile.readline()

            if line in (b'\r\n', b'\n', b''):
                break
            headers_list.append(line)
        headers_str = b''.join(headers_list).decode('iso-8859-1')
        return email.parser.Parser().parsestr(headers_str)

    def check_host(self, headers):
        &quot;&quot;&quot;Is host correct?&quot;&quot;&quot;
        host = headers.get('Host', '')
        logging.debug(f'host: {host}')
        if not host:
            raise Exception('Request without host')
        if host not in (self._server_name,
                        f'{self._host}:{self._port}'):
            raise Exception('Invalid host')

    def handle_request(self, request:Request) -&gt; Response:
        &quot;&quot;&quot;Handle different types of request. Even if this request is not supported&quot;&quot;&quot;
        if request.method == 'GET' and request.url_path == '/':
            return self.handle_get_mark(request)
        if request.method == 'POST' and request.url_path =='/update_marks':
            return self.handle_post_update_marks(request)
        if request.method == 'GET' and request.url_path == &quot;/update_marks&quot;:
            return self.handle_get_update_marks(request)
        if request.method == 'GET' and request.url_path == '/favicon.ico':
            return Response(200, 'OK')

        return self.handle_404(request)

    def handle_post_update_marks(self, request: Request):
        body_encoded = request.body
        body_decoded = body_encoded.decode('iso-8859-1')
        parameters = parse_qs(body_decoded)
        if 'mark' not in parameters:
            raise Exception('No mark in post')
        if 'subject' not in parameters:
            raise Exception('No subject in post')
        mark = parameters['mark'][0]
        if not mark.isnumeric():
            raise Exception('Invalid mark')
        mark = int(mark)
        subject = parameters['subject'][0]

        if subject not in self.marks:
            self.marks[subject] = []
        self.marks[subject].append(mark)
        return Response(204, 'Created')

    def handle_get_mark(self, request: Request):
        content_type = 'text/html; charset=utf-8'
        body = '&lt;html&gt;&lt;head&gt;'
        body += &quot;&quot;&quot;&lt;style&gt;
        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid black;
            text-align: center;
            padding: 8px;
        }
    &lt;/style&gt;&quot;&quot;&quot;
        body += '&lt;/head&gt;&lt;body&gt;'
        body += '&lt;table&gt;'
        for subject in self.marks:
            body += '&lt;tr&gt;'
            body += f'&lt;td&gt;{subject}&lt;/td&gt;'
            for mark in self.marks[subject]:
                body += f'&lt;td&gt;{mark}&lt;/td&gt;'
            body += '&lt;/tr&gt;'
        body += '&lt;/table&gt;'
        body += '&lt;/body&gt;&lt;/html&gt;'

        body = body.encode('utf-8')
        headers = [('Content-Type', content_type),
                   ('Content-Length', len(body))]
        return Response(200, 'OK', headers, body)

    def handle_404(self, request: Request):
        body = '&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;404 not found&lt;/h1&gt;&lt;/body&gt;'
        body = body.encode('utf-8')
        content_type = 'text/html; charset=utf-8'
        headers = [('Content-Type', content_type),
                   ('Content-Length', len(body))]
        return Response(404, 'Not Found', headers, body)


    def handle_get_update_marks(self, request):
        with open('update_marks.html') as f:
            body = ''.join(f.readlines())
        body = body.encode('utf-8')

        headers = [('Content-Type', 'text/html; charset=utf-8'),
                   ('Content-Length', len(body))]
        return Response(200, 'OK', headers, body)

    def send_response(self, conn: socket.socket, resp: Response):
        &quot;&quot;&quot;Convert Response class instance into appropriate test and sends it via socket&quot;&quot;&quot;
        with ConnWriter(conn.makefile('wb')) as wfile_wrapped:
            status_line = f'HTTP/1.1  {resp.status} {resp.reason}'
            wfile_wrapped.encode_and_write(status_line)

            if resp.headers is not None:
                for key, value in resp.headers:
                    header_line = f'{key}: {value}'
                    wfile_wrapped.encode_and_write(header_line)
            wfile_wrapped.write_empty_line()

            if resp.body is not None:
                wfile_wrapped.write_bytes(resp.body)


if __name__ == '__main__':
    format = &quot;%(asctime)s: %(message)s&quot;
    logging.basicConfig(format=format, level=logging.INFO,
                        datefmt=&quot;%H:%M:%S&quot;)
    host = '127.0.0.1'
    port = 14900
    print('Ссылки:\n'
          'Оценки: 127.0.0.1:14900\n'
          'Добавление оценок: 127.0.0.1:14900/update_marks\n')
    name = 'example.local'
    server = MyHTTPServer(host, port, name)
    server.serve_forever()

</code></pre>
<h3 id="update_markshtml">Код update_marks.html</h3>
<p>```html</p>
<!DOCTYPE html>
<html lang="en-GB">
<head>
  <title>Update marks</title>
</head>
<body>

<form action="/update_marks" method="post">
    <label>
        Input mark
        <input type="number" size="3" id="mark" name="mark">
    </label>
    <br>
    <label>
        Input subject
        <input type="text" size="20" id="subject" name="subject">
    </label>
    <div>
        <input type="reset" value="Clear">
        <input type="submit" value="Send">
    </div>
</form>
</body>
</html>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ex4/" class="btn btn-neutral float-left" title="Упраженение 4"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ex4/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
